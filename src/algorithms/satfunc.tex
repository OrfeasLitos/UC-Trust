\Suppressnumber
\begin{lstlisting}[label=satfunc, style=numbers]
(*@$\mathcal{F}_{\mathrm{SAT}}$ \Reactivatenumber@*)
Initialisation:
  (*@$\forall Alice \in \mathcal{P},$@*)
    util((*@$Alice$@*)) = (*@$\bot$@*)

Upon receiving (type, (*@$t$@*)) from (*@$Alice$@*):
  util((*@$Alice$@*)) = (*@$t$@*)

Upon receiving (satisfy, (*@$d, L$@*)) from (*@$Alice$@*):
  If util((*@$Alice$@*)) == (*@$\bot$@*):
    send message (utilityNotSet) to (*@$Alice$@*)
    go to Idle state
  find list = (*@$\left\{\left(Bob, x, s\right) \in L \times \mathbb{R} \times Assets :\right.$@*)
    (*@$s \in$@*) assets((*@$Bob$@*)) and (*@$s \in d$@*) and (*@$x \geq 0$@*) and
    (*@$\mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Alice\right) \geq x$@*) and (*@\label{satfunc:hascoins}@*)
    util((*@$Alice$@*))((*@$\mathcal{G}_{\mathrm{Assets}}.\mathrm{possessions}\left(Alice\right) \cup \left\{s\right\},$@*) (*@\label{satfunc:gains:Alice:start}@*)
        (*@$\mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Alice\right) - x$@*)) >
    util((*@$Alice$@*))((*@$\mathcal{G}_{\mathrm{Assets}}.\mathrm{possessions}\left(Alice\right),
    \mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Alice\right)$@*)) (*@\label{satfunc:gains:Alice:end}@*)
    and
  send (chooseBestSeller, (*@$d$@*), list, (*@$Alice$@*)) to (*@$\mathcal{A}$@*)
  wait for response from (*@$\mathcal{A}$@*)
  If response (*@$\neq$@*) (bestSeller, list, (*@$Bob, x, s$@*)), (*@$Bob \in \mathcal{P}, x \in Money, s \in Asset$@*): (*@\label{satfunc:badresponse}@*)
    util((*@$Bob$@*))((*@$\mathcal{G}_{\mathrm{Assets}}.\mathrm{possessions}\left(Bob\right) \setminus \left\{s\right\},$@*) (*@\label{satfunc:gains:Bob:start}@*)
        (*@$\mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Bob\right) + x$@*)) >
    util((*@$Bob$@*))((*@$\mathcal{G}_{\mathrm{Assets}}.\mathrm{possessions}\left(Bob\right),
    \mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Bob\right)$@*)) (*@\label{satfunc:gains:Bob:end}@*)
    # e.g. (*@$Bob = \bot$@*)
  Else:
    parse response as (bestSeller, list, (*@$Bob, x, s$@*))
  ((*@$Bob, x, s$@*)) = (*@$\argmax\limits_{\left(Bob, x, s\right) \in \texttt{list}}\left\{\right.$@*)util((*@$Alice$@*))((*@$\mathcal{G}_{\mathrm{Assets}}.\mathrm{possessions}\left(Alice\right) \cup \left\{s\right\},$@*)
        (*@$\mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}\left(Alice\right) - x$@*))(*@$\left.\right\}$@*)
  send (pay, (*@$Alice$@*), (*@$Bob$@*), x) to (*@$\mathcal{G}_{\mathrm{Ledger}}$@*) as (*@$Alice$@*)
  send (give, (*@$Bob$@*), (*@$Alice$@*), s) to (*@$\mathcal{G}_{\mathrm{Assets}}$@*) as (*@$Bob$@*)
  send message (satisfied, (*@$d, L$@*)) to (*@$Alice$@*) (*@\label{satfunc:send:satisfied}@*)

Upon receiving (obtain, (*@$s$@*)) from (*@$Alice$@*):
  assets((*@$Alice$@*)) = assets((*@$Alice$@*))(*@$\cup \left\{s\right\}$@*)
  send message (obtained, (*@$s$@*)) to (*@$Alice$@*)

Upon receiving (lose, (*@$s$@*)) from (*@$Alice$@*):
  assets((*@$Alice$@*)) = assets((*@$Alice$@*))(*@$\setminus \left\{s\right\}$@*)
  send message (lost, (*@$s$@*)) to (*@$Alice$@*)
\end{lstlisting}
