\Suppressnumber
\begin{lstlisting}[label=protocol, style=numbers]
(*@$\Pi\left(\Delta_1, \Delta_2, \Delta_3, \Delta_4\right)$ \Reactivatenumber@*)
Declarations:
  set offeredSats

Initalization:
  offeredSats = (*@$\emptyset$@*)

Upon receiving message satisfy((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*):
  listen for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)
    Upon receiving such message:
      go to Idle State
  aux = (*@$L$@*)
  While aux is not empty
    (*@$Bob$@*) = chooseBestSeller((*@$d$@*), aux) # (e.g. with Trust is Risk)
    send message canYouSatisfy((*@$d$@*)) to (*@$Bob$@*)
    wait for response1 from (*@$Bob$@*) for (*@$\Delta_1$@*) steps
    If response1 (*@$\in \left\{\mbox{timeout}, \mbox{IcannotSatisfy(}d\mbox{)}, \mbox{invalid}\right\}$@*)
      aux = aux (*@$\setminus \left\{Bob\right\}$@*)
    Else If response1 == IcanSatisfy((*@$d\mbox{, }x$@*))
      send message doIhaveBalance((*@$x$@*)) to (*@$\mathcal{F}_{Ledger}$@*)
      wait for responseFromLedger from (*@$\mathcal{F}_{Ledger}$@*) for (*@$\Delta_2$@*)
      If responseFromLedger == youHaveBalance((*@$x$@*))
        send message payment((*@$d\mbox{, }x$@*)) to (*@$Bob$@*)
        send message payment((*@$Bob\mbox{, }x$@*)) to (*@$\mathcal{F}_{Ledger}$@*)
        send message paymentSent((*@$d\mbox{, }x\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
        wait for response2 from (*@$Bob$@*) for (*@$\Delta_3$@*) steps
        If response2 (*@$\in \left\{\mbox{timeout}, \mbox{invalid}\right\}$@*)
          send message ignored((*@$d\mbox{, }x\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
        Else If response2 == satString((*@$d\mbox{, }x\mbox{, }s$@*))
          If stringSatisfies((*@$d\mbox{, }s$@*))
            send message satisfied((*@$d\mbox{, }s\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
          Else
            send message partiallySatisfied((*@$d\mbox{, }s\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
        Else
          (Unreachable)
        stop listening for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)
        go to Idle state
    Else
      (Unreachable)
  send message noOneSatisfies((*@$d\mbox{, }L$@*)) to (*@$\mathcal{E}$@*)
  stop listening for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)

Upon receiving message makeAvailable((*@$d\mbox{, }L\mbox{, }x\mbox{, }s$@*)) from (*@$\mathcal{E}$@*)
  offeredSats = (*@$\mbox{offeredSats} \cup \left(d, L, x, s\right)$@*)
  send message madeAvailable((*@$d\mbox{, }L\mbox{, }x\mbox{, }s$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message makeUnavailable((*@$d\mbox{, }L\mbox{, }x\mbox{, }s$@*)) from (*@$\mathcal{E}$@*)
  offeredSats = (*@$\mbox{offeredSats} \setminus \left(d, L, x, s\right)$@*)
  send message madeUnavailable((*@$d\mbox{, }L\mbox{, }x\mbox{, }s$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message obtain((*@$s$@*)) from (*@$\mathcal{E}$@*)
  send message obtain((*@$s$@*)) to (*@$\mathcal{F}_{Trade}$@*)
  wait for response from (*@$\mathcal{F}_{Trade}$@*) (for some steps)
  If response == obtained((*@$s$@*))
    send message obtained((*@$s$@*)) to (*@$\mathcal{E}$@*)
  Else
    send message notObtained((*@$s$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message lose((*@$s$@*)) from (*@$\mathcal{E}$@*)
  send message lose((*@$s$@*)) to (*@$\mathcal{F}_{Trade}$@*)
  wait for response from (*@$\mathcal{F}_{Trade}$@*) (for some steps)
  If response == lost((*@$s$@*))
    send message lost((*@$s$@*)) to (*@$\mathcal{E}$@*)
  Else
    send message notLost((*@$s$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message increaseDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).increaseDirectTrust((*@$Alice\mbox{, }x$@*))
  send message increasedDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message decreaseDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).decreaseDirectTrust((*@$Alice\mbox{, }x$@*))
  send message decreasedDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message stealDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).stealDirectTrust((*@$Alice\mbox{, }x$@*))
  send message stoleDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message canYouSatisfy((*@$d$@*)) from (*@$Alice$@*)
  If (*@$\exists (a, b, c) \in \mbox{offeredSats}: (d == a \wedge Alice \in b)$@*)
    send message IcanSatisfy((*@$d\mbox{, }c$@*)) to (*@$Alice$@*) # (*@$c$@*) is the price
  Else
    send message IcannotSatisfy((*@$d$@*)) to (*@$Alice$@*)

Upon receiving message payment((*@$d\mbox{, }x$@*)) from (*@$Alice$@*)
  If (*@$\exists (a, b, c) \in \mbox{offeredSats}: (d == a \wedge Alice \in b)$@*)
    send message correctPaymentReceived((*@$d\mbox{, }x\mbox{, }Alice$@*)) to (*@$\mathcal{E}$@*)
    listen for message fulfill((*@$d\mbox{, }Alice\mbox{, }s$@*)) or ignore((*@$d\mbox{, }Alice$@*)) from (*@$\mathcal{E}$@*) for (*@$\Delta_4$@*) steps
      Upon receiving message fulfill((*@$d\mbox{, }Alice\mbox{, }s$@*)) from (*@$\mathcal{E}$@*):
        send message satString((*@$d\mbox{, }x\mbox{, }s$@*)) to (*@$Alice$@*)
      Upon receiving message ignore((*@$d\mbox{, }Alice$@*)) from (*@$\mathcal{E}$@*):
        go to Idle state
  Else
    send message wrongPaymentReceived((*@$Alice\mbox{, }d\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)
\end{lstlisting}
