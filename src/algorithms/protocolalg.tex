\Suppressnumber
\begin{lstlisting}[label=protocol, style=numbers]
(*@$\Pi\left(\Delta_1, \Delta_2\right)$ \Reactivatenumber@*)
Declarations:
  set offeredSats

Initalization:
  offeredSats = (*@$\emptyset$@*)

Upon receiving message satisfy((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*):
  listen for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)
    Upon receiving such message:
      go to Idle State
  aux = (*@$L$@*)
  While aux is not empty
    (*@$Bob$@*) = chooseBestSeller(aux) # (e.g. with Trust is Risk)
    send message canYouSatisfy((*@$d$@*)) to (*@$Bob$@*)
    response1 = wait for response from (*@$Bob$@*) for (*@$\Delta_1$@*) steps
    If response1 (*@$\in \left\{\mbox{timeout}, \mbox{IcannotSatisfy(}d\mbox{)}, \mbox{invalid}\right\}$@*)
      aux = aux (*@$\setminus \left\{Bob\right\}$@*)
    Else If response == IcanSatisfy((*@$d\mbox{, }x$@*))
      send message payment((*@$d\mbox{, }x$@*)) to (*@$Bob$@*)
      send message paymentSent((*@$d\mbox{, }x\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
      response2 = wait for response from (*@$Bob$@*) for (*@$\Delta_2$@*) steps
      If response2 (*@$\in \left\{\mbox{timeout}, \mbox{invalid}\right\}$@*)
        send message ignored((*@$d\mbox{, }x\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
      Else If response2 == satString((*@$d\mbox{, }x\mbox{, }s$@*))
        If stringSatisfies((*@$d\mbox{, }s$@*))
          send message satisfied((*@$d\mbox{, }s\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
        Else
          send message partiallySatisfied((*@$d\mbox{, }s\mbox{, }Bob$@*)) to (*@$\mathcal{E}$@*)
      Else
        (Unreachable)
      stop listening for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)
      go to Idle state
    Else
      (Unreachable)
  send message noOneSatisfies((*@$d\mbox{, }L$@*)) to (*@$\mathcal{E}$@*)
  stop listening for message abort((*@$d\mbox{, }L$@*)) from (*@$\mathcal{E}$@*)

Upon receiving message makeAvailable((*@$d\mbox{, }L\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  offeredSats = (*@$\mbox{offeredSats} \cup (d, L, x)$@*)
  send message madeAvailable((*@$d\mbox{, }L\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message makeUnavailable((*@$d\mbox{, }L\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  offeredSats = (*@$\mbox{offeredSats} \setminus (d, L, x)$@*)
  send message madeUnavailable((*@$d\mbox{, }L\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message increaseDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).increaseDirectTrust((*@$Alice\mbox{, }x$@*))
  send message increasedDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message decreaseDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).decreaseDirectTrust((*@$Alice\mbox{, }x$@*))
  send message decreasedDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message stealDirectTrust((*@$Alice\mbox{, }x$@*)) from (*@$\mathcal{E}$@*)
  (*@$\mathcal{F}_{Ledger}$@*).stealDirectTrust((*@$Alice\mbox{, }x$@*))
  send message stoleDirectTrust((*@$Alice\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)

Upon receiving message canYouSatisfy((*@$d$@*)) from (*@$Alice$@*)
  If (*@$\exists (a, b, c) \in \mbox{offeredSats}: (d == a \wedge Alice \in b)$@*)
    send message IcanSatisfy((*@$d\mbox{, }c$@*)) to (*@$Alice$@*) # (*@$c$@*) is the price
  Else
    send message IcannotSatisfy((*@$d$@*)) to (*@$Alice$@*)

Upon receiving message payment((*@$d\mbox{, }x$@*))  from (*@$Alice$@*)
  If (*@$\exists (a, b, c) \in \mbox{offeredSats}: (d == a \wedge Alice \in b)$@*)
    send message correctPaymentReceived((*@$Alice\mbox{, }d\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)
    listen for message fulfill((*@$d\mbox{, }Alice\mbox{, }s$@*)) or ignore((*@$d\mbox{, }Alice$@*)) from (*@$\mathcal{E}$@*)
      Upon receiving message fulfill((*@$d\mbox{, }Alice\mbox{, }s$@*)) from (*@$\mathcal{E}$@*):
        send message satString((*@$d\mbox{, }x\mbox{, }s$@*)) to (*@$Alice$@*)
      Upon receiving message ignore((*@$d\mbox{, }Alice$@*)) from (*@$\mathcal{E}$@*):
        go to Idle state
  Else
    send message wrongPaymentReceived((*@$Alice\mbox{, }d\mbox{, }x$@*)) to (*@$\mathcal{E}$@*)
\end{lstlisting}
